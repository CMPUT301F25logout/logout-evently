name: 'Setup Firebase and Android emulators'
description: 'Sets up Firebase emulator based on ./firebase and an android emulator for tests'

inputs:
  GOOGLE_SERVICES_JSON:
    description: 'Base64 encoded google-services.json from secrets'
    required: true
  GOOGLE_CLIENT_ID:
    description: 'GOOGLE_CLIENT_ID from secrets'
    required: true

runs:
  using: "composite"
  steps:
    - uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: Cache firebase emulators
      uses: actions/cache@v4
      with:
        path: ~/.cache/firebase/emulators
        key: ${{ runner.os }}-firebase-emulators-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-firebase-emulators-

    - name: Install firebase CLI
      run: npm i -g firebase-tools
      shell: bash

    - name: Enable KVM group perms
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
      shell: bash
